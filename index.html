<!DOCTYPE html>
<html lang="en">

<head>
    <title>Quiz Bot</title>
    <meta charset="UTF-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="author" content="Shinkarenko Max" />

    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        function setThemeClass() {
            document.documentElement.className = Telegram.WebApp.colorScheme;
        }
        Telegram.WebApp.onEvent('themeChanged', setThemeClass);
        setThemeClass();
    </script>

    <style>
        /* .wrapper {
        height: 100%;
        width: 100%;
        max-width: 640px;
        margin-left: auto;
        margin-right: auto;
      } */
        .tg-height {
            height: var(--tg-viewport-stable-height, 100vh);
            transition: height 0.35s linear;
        }

        .btn {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            position: relative;
            margin: 10px 0;
            border-radius: 8px;
            color: #ffffff;
            border: none;
            background-color: #667eea;
            letter-spacing: 1px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            -webkit-transition: all 150ms ease;
            transition: all 150ms ease;
        }

        .btn:active {
            -webkit-transform: translateY(-3%);
            transform: translateY(-3%);
            -webkit-box-shadow: 0 4px 8px rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 8px rgba(255, 255, 255, 0.08);
        }

        .btn:disabled,
        .btn[disabled] {
            background-color: rgb(229, 229, 229);
            color: rgb(175, 175, 175);
        }

        #progressbar-full {
            width: 0%;
            transition: width 0.55s linear;
        }
    </style>
</head>

<body>
    <div class="container mx-auto tg-height flex justify-center items-center w-full max-w-xs px-6">
        <div class="w-full">
            <div>
                <span id="progress-text" class="text-base dark:text-blue-500 text-blue-600"></span>
                <div id="progressbar" class="w-9/12 border-0 rounded-full h-2 bg-slate-200">
                    <div id="progressbar-full" class="h-full rounded-full dark:bg-blue-500 bg-blue-600"></div>
                </div>
            </div>
            <div class="flex justify-center">
                <div id="content-section">
                    <p class="text-base leading-relaxed mt-0 mb-4 dark:text-white text-gray-800" id="question"></span>
                    <div id="answers" class="disabled:opacity-5 opacity-1" onchange="changeAnswer()"></div>
                </div>
            </div>
            <div class="flex space-x-2 justify-center">
                <button class="btn w-1/2 h-10" id="sendanswer">answer</button>
            </div>
        </div>
    </div>
    <script>
        // Setup tailwind config
        tailwind.config = {
            darkMode: 'class',
            variants: {
                extend: {
                    opacity: ['disabled'],
                    textColor: ['dark'],
                },
            },
        };

        // Set bot to ready state
        Telegram.WebApp.ready();

        // Get personalized data from Telegram
        let initData = Telegram.WebApp.initData || '';

        // Init state of button
        const sendBtn = document.getElementById('sendanswer');
        sendBtn.disabled = true;

        let rightAsnwersCounter = 0;
        let questionCounter = 0;
        const MAX_QUESTIONS = 3;
        const questions = [
            {
                question: 'What country has the highest life expectancy?',
                answers: ['Hong Kong', 'Switzerland', 'Singapore', 'Italy'],
                rightAnswer: 0,
            },
            {
                question: 'The tallest building in the world is located in which city?',
                answers: ['Dubai', 'New York', 'Shanghai', 'None of the above'],
                rightAnswer: 0,
            },
            {
                question: 'Which country do cities of Perth, Adelade & Brisbane belong to',
                answers: ['USA', 'Greece', 'Australia'],
                rightAnswer: 2,
            },
        ];

        const changeAnswer = (e) => {
            sendBtn.disabled = false;
        };

        const disableForm = (isDisable) => {
            const answers = document.querySelector('#answers').children;

            for (const el of answers) {
                const inputs = el.getElementsByTagName('input');
                const labels = el.getElementsByTagName('label');

                for (const input of inputs) {
                    input.disabled = isDisable;
                }

                for (const label of labels) {
                    label.disabled = isDisable;
                    label.classList.toggle('opacity-50');
                }
            }
        };

        const getNewQuestion = () => {
            questionCounter++;

            // If quiz is ended - return back
            if (questionCounter > MAX_QUESTIONS) {
                sendAnswer();
                return;
            }

            const questionsIndex = questionCounter - 1;
            const currentQuestion = questions[questionsIndex];

            // Update progress
            const progressText = document.getElementById('progress-text');
            const progressBarFull = document.getElementById('progressbar-full');
            progressText.innerText = `${questionCounter} of ${MAX_QUESTIONS}`;
            progressBarFull.style.width = `${(questionCounter / MAX_QUESTIONS) * 100}%`;

            // Update question and answers
            const answersContainer = document.getElementById('answers');
            const question = document.getElementById('question');

            question.innerText = currentQuestion.question;
            answersContainer.innerHTML = '';

            currentQuestion.answers.map((answer, k) => {
                const answerId = `answer-${k + 1}`;
                const itemContainer = document.createElement('div');

                const input = document.createElement('input');
                input.name = 'answer';
                input.type = 'radio';
                input.id = `answer-${k + 1}`;
                input.dataset.id = k;
                input.classList.add(
                    'rounded-full',
                    'h-4',
                    'w-4',
                    'border',
                    'dark:border-white',
                    'border-gray-300',
                    'bg-white',
                    'dark:checked:bg-blue-500',
                    'dark:checked:border-blue-500',
                    'checked:bg-blue-600',
                    'checked:border-blue-600',
                    'focus:outline-none',
                    'transition',
                    'duration-200',
                    'mt-1',
                    'align-top',
                    'bg-no-repeat',
                    'bg-center',
                    'bg-contain',
                    'float-left',
                    'mr-2',
                    'cursor-pointer'
                );

                const label = document.createElement('label');
                label.htmlFor = answerId;
                label.innerText = answer;
                label.classList.add('inline-block', 'dark:text-white', 'text-gray-800');

                itemContainer.appendChild(input);
                itemContainer.appendChild(label);

                answersContainer.appendChild(itemContainer);
            });
        };

        const sendAnswer = () => {
            // If user visited by not inline keyboard we can't reply him with backend
            if (!initData) {
                const result = `Right answers: ${rightAsnwersCounter} of ${MAX_QUESTIONS}`;
                Telegram.WebApp.sendData(result);
                Telegram.WebApp.close();
            } else {
                console.log('Send data to server is not implemented');
            }
        };

        // When button is clicked check answer and send next question else send data to server
        sendBtn.addEventListener('click', (e) => {
            e.preventDefault();

            const checkedAnswer = parseInt(
                document.querySelector('input[name=answer]:checked').dataset.id
            );
            const currentQuestion = questions[questionCounter - 1];
            if (checkedAnswer === currentQuestion.rightAnswer) {
                rightAsnwersCounter++;
            }

            disableForm(true);

            sendBtn.disabled = true;

            getNewQuestion();
        });

        window.addEventListener('load', (e) => {
            getNewQuestion();
        });
    </script>
</body>

</html>